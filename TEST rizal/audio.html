<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>bgm</title>
  <style>
    html,body{margin:0;height:100%}
    audio{display:none}
  </style>
</head>
<body>
  <!-- path fixed: assets/bg/rizal_theme.mp3 -->
  <audio id="bgm" src="assets/bg/rizal_theme.mp3" preload="auto" loop></audio>

  <script>
  (function(){
    const audio = document.getElementById('bgm');
    const TIME_KEY = 'bgm_time_v3';
    const PREF_KEY = 'bgm_pref_v2'; // on|off
    let wantedTime = 0;

    // read saved time first
    try {
      const t = parseFloat(localStorage.getItem(TIME_KEY));
      if (!isNaN(t) && isFinite(t)) wantedTime = t;
    } catch(e){}

    // once metadata is ready, set currentTime accurately
    audio.addEventListener('loadedmetadata', () => {
      try { audio.currentTime = Math.min(wantedTime, audio.duration || wantedTime); } catch(e){}
    });

    // save time frequently
    let tick;
    function startSaving(){
      if (tick) return;
      tick = setInterval(()=>{
        try { localStorage.setItem(TIME_KEY, String(audio.currentTime || 0)); } catch(e){}
      }, 800);
    }

    // commands from pages
    window.addEventListener('message', e => {
      const {cmd} = e.data || {};
      if (cmd === 'play')   play();
      if (cmd === 'pause')  audio.pause();
      if (cmd === 'toggle') audio.paused ? play() : audio.pause();
    });

    // arm on first gesture to satisfy autoplay policies
    function armOnce(){
      if ((localStorage.getItem(PREF_KEY) || 'on') === 'on') play();
      window.removeEventListener('pointerdown', armOnce, true);
      window.removeEventListener('keydown', armOnce, true);
    }
    window.addEventListener('pointerdown', armOnce, true);
    window.addEventListener('keydown', armOnce, true);

    function play(){
      audio.play()
        .then(startSaving)
        .catch(()=>{/* wait for a user gesture if blocked */});
    }
  })();
  </script>
</body>
</html>
